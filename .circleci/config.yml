version: 2.1
executors:
  node-lts:
    docker:
      - image: cimg/node:lts

jobs:
  install:
    executor: node-lts
    steps:
      - checkout
      # - run:
      #     name: 'Install'
      #     command: npm ci
      - persist_to_workspace:
          root: ./
          paths:
            - ./*
  build:
    executor: node-lts
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: 'Build'
          command: npm run build
  unit:
    executor: node-lts
    steps:
      - attach_workspace:
          at: .
      - run:
          name: 'Unit Tests'
          command: npm run test:ci
          environment:
            JEST_JUNIT_OUTPUT_DIR: ./reports/junit/
      - store_test_results:
          path: ./reports/junit/
      - store_artifacts:
          path: ./reports/junit
      - store_artifacts:
          path: coverage
  e2e:
    executor: node-lts
    steps:
      - attach_workspace:
          at: .
      - run:
          name: 'E2E Tests'
          command: npm run e2e
  version:
    executor: node-lts
    steps:
      - attach_workspace:
          at: .
      # - run:
      #     name: 'Version'
      #     command: npx semantic-release -d
      - run:
          command: echo 1.4.0 > old_version && echo 1.5.0 > new_version
      - run:
          name: 'List'
          command: ls -la
      - persist_to_workspace:
          root: ./
          paths:
            - old_version
            - new_version
  deploy:
    executor: node-lts
    steps:
      - attach_workspace:
          at: .
      - run:
          name: 'List'
          command: ls -la
      - run:
          name: 'Deploy'
          command: |
            OLD_VERSION=$(cat old_version)
            NEW_VERSION=$(cat new_version)
            echo "${OLD_VERSION} => ${NEW_VERSION}"
            ssh -oStrictHostKeyChecking=no -v $USER@$IP_ADDRESS "./deploy.sh 001"

workflows:
  build-and-test:
    jobs:
      - install
      # - build:
      #     requires:
      #       - install
      # - unit:
      #     requires:
      #       - install
      # - e2e:
      #     requires:
      #       - install
      - version:
          context: github-versioning
          requires:
            - install
          # requires:
          #   - build
          #   - unit
          #   - e2e
          filters:
            branches:
              only:
                - main
                - deploy
      - deploy:
          context: digital-ocean-deploy
          requires:
            - version
          filters:
            branches:
              only:
                - main
                - deploy
